{% extends 'base.html' %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2>ðŸŽ¨ Custom Plot: {{ text_file.name }}</h2>
            <div>
                <a href="{% url 'plot:plot_selection' %}" class="btn btn-outline-secondary">Select Different File</a>
            </div>
        </div>

        <!-- File Info -->
        <div class="alert alert-info">
            <strong>ðŸ“Š Custom Analysis:</strong> This plot was generated using your custom plotting function with {{ data_count }} data points from {{ text_file.name }}
        </div>

        <!-- Custom Plot -->
        <div class="plot-container">
            <div class="plot-header">
                <h5 class="mb-0">ðŸŽ¨ Your Custom Plot</h5>
                <div class="d-flex gap-2">
                    <a href="{% url 'plot:plot_data_api' text_file.id %}" class="btn btn-outline-info btn-sm" target="_blank">ðŸ“‹ JSON Data</a>
                    <button class="btn btn-outline-primary btn-sm" onclick="downloadCustomPlot()">ðŸ’¾ Download PNG</button>
                </div>
            </div>
            <img src="data:image/png;base64,{{ custom_plot }}" alt="Custom Plot" class="plot-image">
        </div>
    </div>
</div>

<script>
function downloadCustomPlot() {
    // Convert base64 image to blob and download
    const base64Data = '{{ custom_plot }}';
    const byteCharacters = atob(base64Data);
    const byteNumbers = new Array(byteCharacters.length);
    
    for (let i = 0; i < byteCharacters.length; i++) {
        byteNumbers[i] = byteCharacters.charCodeAt(i);
    }
    
    const byteArray = new Uint8Array(byteNumbers);
    const blob = new Blob([byteArray], {type: 'image/png'});
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = '{{ text_file.name }}_custom_plot.png';
    link.click();
    
    URL.revokeObjectURL(link.href);
}
</script>
{% endblock %}
]