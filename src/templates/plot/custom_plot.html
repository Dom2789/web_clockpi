{% extends 'base.html' %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2>🎨 Custom Plot: {{ text_file.name }}</h2>
            <div>
                <a href="{% url 'plot:plot_data' text_file.id %}" class="btn btn-secondary">← Back to All Plots</a>
                <a href="{% url 'plot:plot_selection' %}" class="btn btn-outline-secondary">Select Different File</a>
            </div>
        </div>

        <!-- File Info -->
        <div class="alert alert-info">
            <strong>📊 Custom Analysis:</strong> This plot was generated using your custom plotting function with {{ data_count }} data points from {{ text_file.name }}
        </div>

        <!-- Custom Plot -->
        <div class="plot-container">
            <div class="plot-header">
                <h5 class="mb-0">🎨 Your Custom Plot</h5>
                <button class="btn btn-outline-primary download-btn" onclick="downloadCustomPlot()">💾 Download PNG</button>
            </div>
            <img src="data:image/png;base64,{{ custom_plot }}" alt="Custom Plot" class="plot-image">
        </div>

        <!-- Instructions for customization -->
        <div class="card mt-4">
            <div class="card-header">
                <h5>🔧 How to Customize This Plot</h5>
            </div>
            <div class="card-body">
                <p>To customize this plot with your own function:</p>
                <ol>
                    <li>Edit the <code>your_custom_plot_function()</code> in <code>plotting/views.py</code></li>
                    <li>Replace the example code with your matplotlib plotting logic</li>
                    <li>The function receives data in this format:</li>
                </ol>
                <pre><code>[
    {
        "line_number": 1,
        "content": "text content",
        "length": 25,
        "word_count": 5
    },
    ...
]</code></pre>
            </div>
        </div>
    </div>
</div>

<script>
function downloadCustomPlot() {
    // Convert base64 image to blob and download
    const base64Data = '{{ custom_plot }}';
    const byteCharacters = atob(base64Data);
    const byteNumbers = new Array(byteCharacters.length);
    
    for (let i = 0; i < byteCharacters.length; i++) {
        byteNumbers[i] = byteCharacters.charCodeAt(i);
    }
    
    const byteArray = new Uint8Array(byteNumbers);
    const blob = new Blob([byteArray], {type: 'image/png'});
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = '{{ text_file.name }}_custom_plot.png';
    link.click();
    
    URL.revokeObjectURL(link.href);
}
</script>
{% endblock %}
]